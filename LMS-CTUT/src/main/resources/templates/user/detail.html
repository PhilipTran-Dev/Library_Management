<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title th:text="${book.bookName} + ' - Thư viện CTUT'">Chi tiết tài liệu</title>

    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="icon" type="image/png" sizes="64x64" th:href="@{/images/user/logo_tab.PNG}">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>

    <!-- CSS chung -->
    <link rel="stylesheet" th:href="@{/css/user/layout.css}">
    <link rel="stylesheet" th:href="@{/css/user/header.css}">
    <link rel="stylesheet" th:href="@{/css/user/footer.css}">
    <style>
        .book-cover-card {
            width: 100%;
            max-width: 260px;
            min-height: 360px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #ced4da;
            box-shadow: 0 4px 8px rgba(0, 0, 0, .1);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .book-cover-card img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .section-divider {
            border-top: 1px solid #dee2e6;
            margin: 2rem 0 1.5rem;
        }

        .detail-label {
            font-weight: 600;
            min-width: 220px;
            color: #212529;
        }

        .detail-row {
            display: flex;
            flex-wrap: wrap;
            padding-bottom: .75rem;
        }

        .detail-row .detail-value {
            flex: 1;
            color: #212529;
        }

        .reserve-btn {
            min-width: 160px;
            font-size: 1rem;
            font-weight: 600;
        }

        .badge-status {
            font-size: .8rem;
        }
    </style>
</head>
<body class="bg-white">

<!-- Header -->
<div th:replace="~{components/user/header :: header}"></div>

<div class="container py-4">

    <!-- link quay lại -->
    <div class="mb-3">
        <a th:href="@{/user/search}" class="text-decoration-none small text-secondary">
            <i class="bi bi-arrow-left"></i>
            <span class="ms-1">Quay lại tìm kiếm</span>
        </a>
    </div>

    <!-- Hàng trên: ảnh bìa + tóm tắt -->
    <div class="row g-4">
        <!-- Bìa -->
        <div class="col-md-4 d-flex justify-content-center">
            <div class="book-cover-card">
                <img th:if="${book.image != null && book.image != ''}"
                     th:src="${book.image}"
                     alt="Bìa sách">
                <img th:if="${book.image == null || book.image == ''}"
                     th:src="@{/images/user/no-cover.png}"
                     alt="Không có ảnh bìa">
            </div>
        </div>

        <!-- Thông tin -->
        <div class="col-md-8">
            <h4 class="fw-semibold mb-3 text-dark" th:text="${book.bookName}">
                Tên sách
            </h4>

            <div class="mb-3">
                <div class="row">
                    <div class="col-sm-4 fw-semibold text-dark">Tác giả:</div>
                    <div class="col-sm-8 text-dark"
                         th:if="${book.authors != null && !#lists.isEmpty(book.authors)}"
                         th:text="${#strings.listJoin(book.authors.![name], ', ')}">
                    </div>
<!--                    <div class="col-sm-8 text-dark"-->
<!--                        th:if="${book.authors == null || #lists.isEmpty(book.authors)}">-->
<!--                        Không rõ-->
<!--                    </div>-->
                </div>

                <div class="row">
                    <div class="col-sm-4 fw-semibold text-dark">Loại tài liệu:</div>
                    <div class="col-sm-8 text-dark">
                        <span th:text="${book.category != null ? book.category.name : 'Không rõ'}"></span>
                    </div>
                </div>

<!--                <div class="row">-->
<!--                    <div class="col-sm-4 fw-semibold text-dark">Số lượng còn lại:</div>-->
<!--                    <div class="col-sm-8 text-dark">-->
<!--                        <span th:text="${book.quantity}">-->
<!--                        </span>-->
<!--                    </div>-->
<!--                </div>-->

                <div class="row">
                    <div class="col-sm-4 fw-semibold text-dark">Tình trạng:</div>
                    <div class="col-sm-8 text-dark">
                        <span class="badge badge-status px-2 py-1"
                              th:classappend="${
                                  #strings.containsIgnoreCase(book.status,'còn') ? 'bg-success' :
                                  (#strings.containsIgnoreCase(book.status,'hết') ? 'bg-danger' : 'bg-secondary')
                              }"
                              th:text="${book.status != null ? book.status : 'Không rõ'}">
                            Còn sách
                        </span>
                    </div>
                </div>
            </div>

            <!-- Nội dung tóm tắt -->
            <div class="mb-4">
                <div class="fw-semibold text-dark mb-1">Nội dung tóm tắt:</div>
                <div class="text-dark" style="font-size:0.95rem; line-height:1.5;"
                     th:text="${book.description != null ? book.description : 'Chưa có mô tả cho tài liệu này.'}">
                    Đây là phần mô tả nội dung chính...
                </div>
            </div>

            <button class="btn btn-primary"
                    th:if="${user != null}"
                    th:attr="onclick=|reserveBook(${book.id}, ${user.id})|">
                <i class="bi bi-journal-arrow-down me-2"></i>
                Đặt mượn
            </button>


            <!-- Thông báo sau khi đặt mượn -->
            <div th:if="${message != null}"
                 class="alert alert-info py-2 px-3 mb-0"
                 th:text="${message}">
                Yêu cầu mượn sách đã được gửi!
            </div>
        </div>
    </div>

    <!-- Gạch ngang -->
    <div class="section-divider"></div>

    <!-- Thông tin chi tiết -->
    <h5 class="fw-semibold text-dark mb-4">Thông tin chi tiết</h5>

    <div class="detail-row">
        <div class="detail-label">Tác giả:</div>
        <div class="detail-value">
            <span th:if="${book.authors != null && !#lists.isEmpty(book.authors)}"
                                        th:text="${#strings.listJoin(book.authors.![name], ', ')}">
</span>
            <span th:if="${book.authors == null || #lists.isEmpty(book.authors)}">
    Không rõ
</span>
        </div>
    </div>

    <div class="detail-row">
        <div class="detail-label">Thông tin nhan đề:</div>
        <div class="detail-value">
            <span th:text="${book.bookName}">Tên sách</span>
        </div>
    </div>
    <div class="detail-row">
        <div class="detail-label">ISBN:</div>
        <div class="detail-value"
             th:text="${book.isbn != null ? book.isbn : '—'}">
            978-xxx
        </div>
    </div>

    <div class="detail-row">
        <div class="detail-label">Từ khóa / Thể loại:</div>
        <div class="detail-value"
             th:text="${book.category.name != null ? book.category.name : 'Chưa cập nhật'}">
            Kinh tế ; Du lịch ; v.v.
        </div>
    </div>
</div>

<!-- Footer -->
<div th:replace="~{components/user/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    function reserveBook(bookId, userId) {
        fetch('/api/borrow/request', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({bookId: bookId, userId: userId})
        })
                .then(async res => {
                    if (!res.ok) {
                        const errorMessage = await res.text();
                        Swal.fire({
                            icon: "error",
                            title: "Không thể đặt mượn",
                            text: errorMessage
                        });
                        return;
                    }

                    Swal.fire({
                        icon: "success",
                        title: "Đặt mượn thành công!",
                        showConfirmButton: false,
                        timer: 1500
                    });
                })
                .catch(err => {
                    Swal.fire({
                        icon: "error",
                        title: "Lỗi kết nối server",
                        text: "Vui lòng thử lại!"
                    });
                });
    }

</script>
<script>
    let stompClient = null;

    function connectWebSocket() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // Subscribe topic mà server push dữ liệu mới
            stompClient.subscribe('/topic/orderBook', function (message) {
                const req = JSON.parse(message.body);
                addReserveToTable(req);
            });
        });
    }

    // Chèn dữ liệu mới vào table
    function addReserveToTable(req) {
        const tbody = document.querySelector('#tblReserveListModal tbody');
        if (!tbody) return;

        const rowCount = tbody.rows.length;
        const row = tbody.insertRow();

        row.insertCell(0).innerText = rowCount + 1;
        row.insertCell(1).innerText = new Date(req.createdAt).toLocaleString();
        row.insertCell(2).innerText = new Date(req.deadline).toLocaleString();
        row.insertCell(3).innerText = req.fullName;
        row.insertCell(4).innerText = req.bookCode;
        row.insertCell(5).innerText = req.bookName;
        const statusCell = row.insertCell(6);
        statusCell.innerHTML = `
        <span class="badge text-bg-warning">${req.borrowStatus}</span>
    `;
        row.insertCell(7).innerText = req.phone;
    }

    // Kết nối WebSocket khi load modal hoặc trang
    connectWebSocket();
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


</body>
</html>

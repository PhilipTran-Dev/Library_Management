<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <title>Quản lý đọc giả - Thư viện CTUT</title>

    <link rel="icon" type="image/png" sizes="64x64" th:href="@{/images/logo_tab.PNG}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <!-- CSS chung -->
    <link rel="stylesheet" th:href="@{/css/librarian/header.css}"/>
    <link rel="stylesheet" th:href="@{/css/librarian/sidebar.css}"/>
    <link rel="stylesheet" th:href="@{/css/librarian/layout.css}"/>
    <!-- CSS riêng -->
    <link rel="stylesheet" th:href="@{/css/librarian/readers.css}"/>
</head>
<body>
<!-- Header fragment -->
<div th:replace="components/librarian/header :: header"></div>

<!-- App layout -->
<div class="app-layout d-flex">
    <!-- Sidebar fragment: truyền key 'readers' để active menu -->
    <aside th:replace="components/librarian/sidebar :: sidebar('readers')"></aside>

    <!-- Main -->
    <main class="flex-grow-1">
        <div class="container py-4">
            <!-- thông báo -->
            <div th:if="${deleteUserSuccess}" class="alert alert-success text-center"
                 th:text="${deleteUserSuccess}">
            </div>
            <div th:if="${errorPhoneNumber}" class="alert alert-danger text-center"
                 th:text="${errorPhoneNumber}">
            </div>
            <div th:if="${errorExistsEmail}" class="alert alert-danger text-center"
                 th:text="${errorExistsEmail}">
            </div>
            <div th:if="${errorDateOfBirth}" class="alert alert-danger text-center"
                 th:text="${errorDateOfBirth}">
            </div>
            <div th:if="${errorSaveUser}" class="alert alert-danger text-center"
                 th:text="${errorSaveUser}">
            </div>
            <div th:if="${successSaveUser}" class="alert alert-success text-center"
                 th:text="${successSaveUser}">
            </div>
            <div th:if="${errorEditUser}" class="alert alert-danger text-center"
                 th:text="${errorEditUser}">
            </div>
            <div th:if="${errorExistUser}" class="alert alert-danger text-center"
                 th:text="${errorExistUser}">
            </div>
            <div th:if="${successEditUser}" class="alert alert-success text-center"
                 th:text="${successEditUser}">
            </div>


            <!-- Title + actions -->
            <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                <div class="d-flex gap-2">
                    <button id="btnExport" class="btn btn-outline-secondary">
                        <i class="bi bi-filetype-csv me-1"></i>Xuất CSV
                    </button>

                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importCsvModal">
                        <i class="bi bi-filetype-csv me-1"></i> Nhập CSV
                    </button>

                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#readerModal">
                        <i class="bi bi-plus-lg me-1"></i> Thêm độc giả
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-3">
                <div class="card-body">
                    <form th:action="@{/librarian/searchUsers}"
                          id="filterForm"
                          class="toolbar d-flex flex-wrap align-items-center"
                          method="GET">

                        <!-- Keyword -->
                        <div class="input-group rounded-12 me-2 mb-2" style="max-width: 380px">
                <span class="input-group-text bg-white">
                    <i class="bi bi-search"></i>
                </span>
                            <input th:value="${keyword}"
                                   name="keyword"
                                   class="form-control"
                                   placeholder="Tìm theo tên, mã độc giả, email, số ĐT..."/>
                        </div>

                        <!-- Status -->
                        <select name="userStatus"
                                class="form-select rounded-12 me-2 mb-2"
                                style="max-width: 200px">
                            <option value="">Tất cả trạng thái</option>
                            <option value="Hoạt động"
                                    th:selected="${userStatus == 'Hoạt động'}">Hoạt động
                            </option>
                            <option value="Ngưng hoạt động"
                                    th:selected="${userStatus == 'Ngưng hoạt động'}">Ngưng hoạt động
                            </option>
                            <option value="Đã khóa"
                                    th:selected="${userStatus == 'Đã khóa'}">Đã khóa
                            </option>
                        </select>

                        <!-- Unit -->
                        <select name="unitId"
                                class="form-select rounded-12 me-2 mb-2"
                                style="max-width: 220px">
                            <option value="">Faculties / Institutes</option>

                            <option th:each="unit : ${units}"
                                    th:value="${unit.id}"
                                    th:text="${unit.name}"
                                    th:selected="${unit.id == unitId}">
                            </option>
                        </select>

                        <!-- Submit -->
                        <button type="submit" class="btn btn-primary rounded-12 mb-2 me-2">
                            <i class="bi bi-funnel me-1"></i>Lọc
                        </button>

                        <!-- Reset -->
                        <div class="ms-auto">
                            <a th:href="@{/librarian/readers(page=0, pageSize=10)}"
                               class="btn btn-outline-secondary text-dark text-decoration-none">
                                <i class="bi bi-arrow-repeat me-1"></i> Đặt lại
                            </a>
                        </div>
                    </form>
                </div>
            </div>


            <!-- Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-modern mb-0 w-100" id="tblReaders">
                            <thead>
                            <tr>
                                <th style="width: 110px">Mã</th>
                                <th>Độc giả</th>
                                <th>Email</th>
                                <th>Điện thoại</th>
                                <th>Địa Chỉ</th>
                                <th>Khoa/Viện</th>
                                <th>Trạng Thái</th>
                                <th>Vai Trò</th>
                                <th class="text-end" style="width: 140px">Thao tác</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="users : ${userPageContent}"
                                th:if="${users.roles.name() == 'USERS'}">
                                <td th:text="${users.id}"></td>
                                <td th:text="${users.fullName}"></td>
                                <td th:text="${users.email}"></td>
                                <td th:text="${users.phoneNumber}"></td>
                                <td th:text="${users.address}"></td>
                                <td th:text="${users.unit != null ? users.unit.name : 'Chưa phân đơn vị'}"></td>
                                <td th:text="${users.userStatus}"></td>
                                <td th:text="${users.roles}"></td>
                                <td class="text-end">
                                    <a th:href="@{/librarian/readers(id=${users.id}, page=${currentPage})}"
                                       class="btn btn-sm btn-outline-primary me-1">Sửa</a>
                                    <a th:href="@{/librarian/deleteUsers(id=${users.id},  page=${currentPage})}"
                                       class="btn btn-sm btn-outline-danger">Xóa</a>
                                </td>
                            </tr>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav th:if="${totalPages != null and totalPages > 0}">
                        <ul class="pagination">

                            <!-- Previous -->
                            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                <a class="page-link"
                                   th:href="${isSearching} ?
        @{/librarian/searchUsers(
            page=${currentPage > 0 ? currentPage - 1 : 0},
            pageSize=${pageSize},
            keyword=${keyword},
            userStatus=${userStatus},
            unitId=${unitId})}
        :
        @{/librarian/readers(
            page=${currentPage > 0 ? currentPage - 1 : 0},
            pageSize=${pageSize})}">
                                    Previous
                                </a>
                            </li>


                            <!-- Page numbers -->
                            <li class="page-item"
                                th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                th:classappend="${i == currentPage} ? 'active'">
                                <a class="page-link"
                                   th:text="${i + 1}"
                                   th:href="${isSearching} ?
@{/librarian/searchUsers(
    page=${i},
    pageSize=${pageSize},
    keyword=${keyword},
    userStatus=${userStatus},
    unitId=${unitId}
)}
:
@{/librarian/readers(
    page=${i},
    pageSize=${pageSize}
)}">
                                </a>
                            </li>

                            <!-- Next -->
                            <li class="page-item"
                                th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                                <a class="page-link"
                                   th:href="${isSearching} ?
@{/librarian/searchUsers(
    page=${currentPage < totalPages - 1 ? currentPage + 1 : totalPages - 1},
    pageSize=${pageSize},
    keyword=${keyword},
    userStatus=${userStatus},
    unitId=${unitId}
)}
:
@{/librarian/readers(
    page=${currentPage < totalPages - 1 ? currentPage + 1 : totalPages - 1},
    pageSize=${pageSize}
)}">
                                    Next
                                </a>
                            </li>

                        </ul>
                    </nav>

                </div>
            </div>
        </div>
    </main>
</div>
<!-- Thêm thông tin người dùng -->
<div class="modal fade" id="readerModal" tabindex="-1" aria-labelledby="readerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-sm">
            <div class="modal-header">
                <h5 class="modal-title fw-semibold" id="readerModalLabel">Thêm độc giả mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>

            <div class="modal-body">
                <form th:action="@{/librarian/saveUsers}" method="post" id="addUserForm">

                    <div class="row g-3">

                        <!-- Họ tên -->
                        <div class="col-sm-6">
                            <label class="form-label">Họ và tên</label>
                            <input type="text" name="fullName" class="form-control" placeholder="Nhập họ tên" required>
                        </div>

                        <!-- Email -->
                        <div class="col-sm-6">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" placeholder="Nhập email" required>
                        </div>

                        <!-- Số điện thoại -->
                        <div class="col-sm-6">
                            <label class="form-label">Số điện thoại</label>
                            <input type="text" name="phoneNumber" class="form-control" placeholder="VD: 0901234567"
                                   required pattern="\d{10}">
                        </div>

                        <!-- Địa chỉ -->
                        <div class="col-sm-6">
                            <label class="form-label">Địa chỉ</label>
                            <input type="text" name="address" class="form-control" placeholder="Nhập địa chỉ" required>
                        </div>

                        <!-- Khoa/Viện -->
                        <div class="col-sm-6">
                            <label class="form-label">Khoa/Viện</label>
                            <select name="unitId" class="form-select" required>
                                <option value="" disabled selected>Faculties / Institutes</option>

                                <option th:each="unit : ${units}"
                                        th:value="${unit.id}"
                                        th:text="${unit.name}">
                                </option>
                            </select>
                        </div>


                        <!-- Ngày sinh -->
                        <div class="col-sm-6">
                            <label class="form-label">Ngày sinh</label>
                            <input type="date" id="dob" class="form-control" required>
                            <input type="hidden" name="dayofBirth" id="dayofBirth">
                            <input type="hidden" name="monthofBirth" id="monthofBirth">
                            <input type="hidden" name="yearofBirth" id="yearofBirth">
                        </div>

                        <!-- Mật khẩu -->
                        <div class="col-sm-6">
                            <label class="form-label">Mật khẩu</label>
                            <input type="password" name="password" class="form-control" placeholder="Nhập mật khẩu"
                                   required>
                        </div>

                        <!-- Vai trò -->
                        <div class="col-sm-6">
                            <label class="form-label">Vai trò</label>
                            <select name="roles" class="form-select">
                                <option value="USERS">User</option>
                            </select>
                        </div>

                        <!-- Trạng thái -->
                        <div class="col-sm-6">
                            <label class="form-label">Trạng thái</label>
                            <select name="userStatus" class="form-select">
                                <option value="Hoạt động">Hoạt động</option>
                                <option value="Ngưng hoạt động">Ngưng hoạt động</option>
                                <option value="Đã khóa">Đã khóa</option>
                            </select>
                        </div>

                    </div>

                    <!-- Footer -->
                    <div class="mt-4 text-end">
                        <button type="submit" class="btn btn-primary rounded-3 px-4">Lưu</button>
                        <button type="button" class="btn btn-outline-secondary rounded-3 px-4" data-bs-dismiss="modal">
                            Hủy
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Sửa thông tin người dùng -->
<div class="modal fade" id="editReaders" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form th:action="@{/librarian/saveEditUsers}" method="post" th:object="${editUsers}" class="modal-content">
            <input type="hidden" th:field="*{id}"/>
            <input type="hidden" name="page" th:value="${currentPage}"/>
            <div class="modal-header">
                <h5 class="modal-title">Sửa thông tin độc giả</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-sm-6">
                        <label class="form-label">Họ và tên</label>
                        <input th:field="*{fullName}" class="form-control" required/>
                    </div>

                    <div class="col-sm-6">
                        <label class="form-label">Email</label>
                        <input th:field="*{email}" type="email" class="form-control" required readonly/>
                    </div>

                    <div class="col-sm-6">
                        <label class="form-label">Số điện thoại</label>
                        <input th:field="*{phoneNumber}" class="form-control" pattern="\d{10}" required/>
                    </div>

                    <div class="col-sm-6">
                        <label class="form-label">Khoa/Viện</label>
                        <select name="unitId" class="form-select" required>
                            <option th:each="unit : ${units}"
                                    th:value="${unit.id}"
                                    th:text="${unit.name}"
                                    th:selected="${editUsers != null and unit.id == editUsers.unit?.id}">
                            </option>
                        </select>
                    </div>

                    <div class="col-sm-6">
                        <label class="form-label">Địa chỉ</label>
                        <input th:field="*{address}" class="form-control" required/>
                    </div>

                    <div class="col-sm-6">
                        <label class="form-label">Trạng thái</label>
                        <select th:field="*{userStatus}" class="form-select">
                            <option th:value="'Hoạt động'">Hoạt động</option>
                            <option th:value="'Ngưng hoạt động'">Ngưng hoạt động</option>
                            <option th:value="'Đã khóa'">Đã khóa</option>
                        </select>
                    </div>

                    <div class="col-sm-6">
                        <label class="form-label">Vai trò</label>
                        <select th:field="*{roles}" class="form-select">
                            <option th:value="'USERS'">User</option>
                            <option th:value="'Librarian'">Librarian</option>
                            <option th:value="'ADMIN'">Admin</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
            </div>
        </form>
    </div>
</div>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- App JS (nếu cần): chuyển sang @ để chạy từ /static -->
<script defer th:src="@{/js/librarian/header.js}"></script>
<script defer th:src="@{/js/librarian/sidebar.js}"></script>
<script defer th:src="@{/js/librarian/inject-layout.js}"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    let showModal = /*[[${showEditModal}]]*/ false;

    // Nếu showEditModal = true từ controller => bật modal
    if (showModal) {
        let editModal = new bootstrap.Modal(document.getElementById('editReaders'));
        editModal.show();
    }
    /*]]>*/
</script>
<!-- Script xử lý ngày sinh -->
<script>
    document.getElementById('dob').addEventListener('change', function () {
        const date = new Date(this.value);
        document.getElementById('dayofBirth').value = date.getDate();
        document.getElementById('monthofBirth').value = date.getMonth() + 1;
        document.getElementById('yearofBirth').value = date.getFullYear();
    });
</script>
<script>
    document.getElementById("dob").addEventListener("change", function () {
        const date = this.value.split("-");
        document.getElementById("yearofBirth").value = date[0];
        document.getElementById("monthofBirth").value = date[1];
        document.getElementById("dayofBirth").value = date[2];
    });
</script>
<script>
    setTimeout(() => {
        document.querySelectorAll('.alert').forEach(alert => {
            alert.classList.remove('show');
        });
    }, 3000);
</script>
<!-- xuất csv -->
<script>
    document.getElementById("btnExport").addEventListener("click", function () {
        window.location.href = "/librarian/exportUsers";
    });
</script>
</body>
</html>
